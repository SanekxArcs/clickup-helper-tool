<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit History Item Test</title>
    <script src="tailwind_css.js"></script>
    <link rel="stylesheet" href="custom.css">
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">Edit History Item Test</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">Instructions</h2>
            <ol class="list-decimal list-inside space-y-2 text-sm">
                <li>First, create a test history item by clicking "Add Test Item"</li>
                <li>Click the ‚úèÔ∏è edit button to open the edit modal</li>
                <li>Modify the fields and click "Save Changes"</li>
                <li>Verify the changes are reflected in the history display</li>
                <li>Test editing GitLab merge request URL field</li>
                <li>Test status selector in edit modal</li>
            </ol>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">Test Actions</h2>
            <div class="flex gap-2 mb-4">
                <button id="addTestItem" class="bg-blue-50 ring-1 ring-blue-400 text-black border-none px-4 py-2 rounded cursor-pointer text-sm font-medium hover:bg-blue-100 transition-all duration-300">
                    ‚ûï Add Test Item
                </button>
                <button id="clearHistory" class="bg-red-50 ring-1 ring-red-400 text-black border-none px-4 py-2 rounded cursor-pointer text-sm font-medium hover:bg-red-100 transition-all duration-300">
                    üóëÔ∏è Clear History
                </button>
            </div>
        </div>

        <!-- History Tab Content -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-lg font-semibold mb-4">History</h2>
            
            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <label for="historySearch" class="font-semibold text-gray-700">üîç Search & Filter History:</label>
                    <div id="autoSearchIndicator" class="hidden truncate text-xs text-blue-600 bg-blue-50 px-2 rounded-md border border-blue-200">
                        üîç Auto-searched
                    </div>
                </div>
                <div class="flex gap-2">
                    <div class="flex-1 relative">
                        <input type="text" id="historySearch" placeholder="Search by task ID or title..." class="w-full p-2.5 pr-8 border-2 border-gray-200 rounded-md text-sm transition-colors duration-300 box-border focus:outline-none focus:border-blue-500">
                        <button id="clearSearchBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 text-lg font-normal w-5 h-5 items-center justify-center rounded-full hover:bg-gray-200 transition-all duration-200 cursor-pointer hidden" title="Clear search" style="display: none; line-height: 1;">√ó</button>
                    </div>
                    <select id="statusFilter" class="px-3 py-2.5 border-2 border-gray-200 rounded-md text-sm transition-colors duration-300 box-border focus:outline-none focus:border-blue-500 bg-white min-w-[140px]">
                        <option value="">All Statuses</option>
                        <option value="in-specification">In Specification</option>
                        <option value="in-progress">In Progress</option>
                        <option value="code-review">Code Review</option>
                        <option value="completed">Completed</option>
                        <option value="in-review">In Review</option>
                        <option value="rejected-cr">Rejected (CR)</option>
                        <option value="rejected">Rejected</option>
                        <option value="blocked">Blocked</option>
                        <option value="done">Done</option>
                        <option value="on-hold">On Hold</option>
                        <option value="ready-release">Ready to Release</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>
            </div>
            
            <div id="historyContainer">
                <div class="text-center text-gray-500 italic py-10 px-5">
                    No generation history yet. Click "Add Test Item" to create test data.
                </div>
            </div>
        </div>
    </div>

    <!-- Edit History Item Modal -->
    <div id="editModal" class="edit-modal hidden fixed top-0 left-0 w-full h-full bg-black/50 z-[1000] backdrop-blur-sm">
        <div class="edit-modal-content bg-white rounded-xl p-6 w-[500px] max-w-[90vw] max-h-[80vh] overflow-y-auto shadow-2xl modal-animation">
            <div class="flex justify-between items-center mb-5 pb-4 border-b-2 border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 m-0">‚úèÔ∏è Edit History Item</h3>
                <button class="bg-transparent border-none text-2xl cursor-pointer text-gray-500 w-auto m-0 p-0 leading-none hover:text-red-500 hover:transform-none hover:shadow-none" id="editModalCloseBtn">&times;</button>
            </div>
            
            <div class="mb-4">
                <label for="editTaskId" class="block mb-2 font-semibold text-gray-700">Task ID:</label>
                <input type="text" id="editTaskId" placeholder="e.g., WDEV-13729" class="w-full p-2.5 border-2 border-gray-200 rounded-md text-sm transition-colors duration-300 box-border focus:outline-none focus:border-blue-500">
            </div>
            
            <div class="mb-4">
                <label for="editTaskTitle" class="block mb-2 font-semibold text-gray-700">Task Title:</label>
                <input type="text" id="editTaskTitle" placeholder="Brief task description" class="w-full p-2.5 border-2 border-gray-200 rounded-md text-sm transition-colors duration-300 box-border focus:outline-none focus:border-blue-500">
            </div>
            
            <div class="mb-4">
                <label for="editTaskDescription" class="block mb-2 font-semibold text-gray-700">Task Description:</label>
                <textarea id="editTaskDescription" placeholder="Detailed task description" class="w-full p-2.5 border-2 border-gray-200 rounded-md text-sm transition-colors duration-300 box-border focus:outline-none focus:border-blue-500 h-20 resize-y"></textarea>
            </div>
            
            <div class="mb-4">
                <label for="editSourceUrl" class="block mb-2 font-semibold text-gray-700">Source URL:</label>
                <input type="url" id="editSourceUrl" placeholder="https://example.com/task-url" class="w-full p-2.5 border-2 border-gray-200 rounded-md text-sm transition-colors duration-300 box-border focus:outline-none focus:border-blue-500">
            </div>
            
            <div class="mb-4">
                <label for="editGitlabMergeRequestUrl" class="block mb-2 font-semibold text-gray-700">GitLab Merge Request URL:</label>
                <input type="url" id="editGitlabMergeRequestUrl" placeholder="https://gitlab.com/project/merge_requests/123" class="w-full p-2.5 border-2 border-gray-200 rounded-md text-sm transition-colors duration-300 box-border focus:outline-none focus:border-blue-500">
            </div>
            
            <div class="mb-4">
                <label for="editBranchName" class="block mb-2 font-semibold text-gray-700">Branch Name:</label>
                <input type="text" id="editBranchName" placeholder="feature/task-branch-name" class="w-full p-2.5 border-2 border-gray-200 rounded-md text-sm transition-colors duration-300 box-border focus:outline-none focus:border-blue-500">
            </div>
            
            <div class="mb-4">
                <label for="editCommitMessage" class="block mb-2 font-semibold text-gray-700">Commit Message:</label>
                <input type="text" id="editCommitMessage" placeholder="feat: implement new feature" class="w-full p-2.5 border-2 border-gray-200 rounded-md text-sm transition-colors duration-300 box-border focus:outline-none focus:border-blue-500">
            </div>
            
            <div class="mb-4">
                <label for="editStatus" class="block mb-2 font-semibold text-gray-700">Status:</label>
                <select id="editStatus" class="w-full p-2.5 border-2 border-gray-200 rounded-md text-sm transition-colors duration-300 box-border focus:outline-none focus:border-blue-500 bg-white">
                    <option value="in-specification">In Specification</option>
                    <option value="in-progress">In Progress</option>
                    <option value="code-review">Code Review</option>
                    <option value="completed">Completed</option>
                    <option value="in-review">In Review</option>
                    <option value="rejected-cr">Rejected (CR)</option>
                    <option value="rejected">Rejected</option>
                    <option value="blocked">Blocked</option>
                    <option value="done">Done</option>
                    <option value="on-hold">On Hold</option>
                    <option value="ready-release">Ready to Release</option>
                    <option value="closed">Closed</option>
                </select>
            </div>
            
            <div class="flex gap-2.5 mt-5 pt-4 border-t border-gray-200">
                <button class="bg-blue-50 ring-1 ring-blue-400 text-black border-none px-3 py-3 rounded cursor-pointer text-xs font-medium whitespace-nowrap flex-1 w-full hover:bg-blue-100 transition-all duration-300" id="editModalSaveBtn">üíæ Save Changes</button>
                <button class="bg-red-50 ring-1 ring-red-400 text-black border-none px-3 py-3 rounded cursor-pointer text-xs font-medium whitespace-nowrap flex-1 w-full hover:bg-red-100 transition-all duration-300" id="editModalCancelBtn">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { HistoryTab } from './tabs/history/history.js';
        import { Utils } from './shared/utils.js';

        // Mock chrome.storage.local for testing
        if (typeof chrome === 'undefined') {
            window.chrome = {
                storage: {
                    local: {
                        data: {},
                        get: function(keys, callback) {
                            const result = {};
                            if (typeof keys === 'string') {
                                result[keys] = this.data[keys];
                            } else if (Array.isArray(keys)) {
                                keys.forEach(key => {
                                    result[key] = this.data[key];
                                });
                            } else if (typeof keys === 'object') {
                                Object.keys(keys).forEach(key => {
                                    result[key] = this.data[key] || keys[key];
                                });
                            }
                            callback(result);
                        },
                        set: function(items, callback) {
                            Object.assign(this.data, items);
                            if (callback) callback();
                        },
                        remove: function(keys, callback) {
                            if (typeof keys === 'string') {
                                delete this.data[keys];
                            } else if (Array.isArray(keys)) {
                                keys.forEach(key => delete this.data[key]);
                            }
                            if (callback) callback();
                        }
                    }
                },
                tabs: {
                    query: function(queryInfo, callback) {
                        callback([{
                            id: 1,
                            url: 'http://localhost/test-edit-history.html'
                        }]);
                    }
                }
            };
        }

        // Initialize the history tab
        const historyTab = new HistoryTab();
        historyTab.onActivate();

        // Add test item functionality
        document.getElementById('addTestItem').addEventListener('click', () => {
            const testItem = {
                taskId: 'TEST-' + Math.floor(Math.random() * 1000),
                taskTitle: 'Test Task for Edit Feature',
                taskDescription: 'This is a test task to verify edit functionality works properly.',
                sourceUrl: 'https://example.com/task-url',
                gitlabMergeRequestUrl: 'https://gitlab.com/project/merge_requests/123',
                branchName: 'feature/test-edit-feature',
                commitMessage: 'feat: add test edit functionality',
                status: 'in-progress',
                timestamp: Date.now()
            };
            
            historyTab.saveToHistory(testItem).then(() => {
                historyTab.loadHistory();
                Utils.showNotification('Test item added to history');
            });
        });

        // Clear history functionality
        document.getElementById('clearHistory').addEventListener('click', () => {
            historyTab.clearHistory();
        });

        // Show success message
        Utils.showNotification('Edit History Test Page Loaded Successfully');
    </script>
</body>
</html>
